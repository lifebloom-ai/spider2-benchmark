-- Step 4: Calculate Percentage Change in Post-Market Close Prices
WITH price_changes AS (
    SELECT 
        TICKER, 
        MAX(CASE WHEN DATE = '2024-01-02' THEN VALUE END) AS START_PRICE,
        MAX(CASE WHEN DATE = '2024-06-28' THEN VALUE END) AS END_PRICE
    FROM (
        SELECT TICKER, DATE, VALUE
        FROM FINANCE__ECONOMICS.CYBERSYN.STOCK_PRICE_TIMESERIES
        WHERE VARIABLE_NAME = 'Post-Market Close'
        AND DATE IN ('2024-01-02', '2024-06-28')
        AND TICKER IN ('AAPL', 'AMZN', 'GOOGL', 'META', 'MSFT', 'NVDA', 'TSLA')
    )
    GROUP BY TICKER
)
SELECT 
    TICKER,
    START_PRICE, 
    END_PRICE,
    ROUND(((END_PRICE - START_PRICE) / START_PRICE) * 100, 2) AS PERCENTAGE_CHANGE
FROM price_changes
ORDER BY TICKER;